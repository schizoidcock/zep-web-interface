{{ define "ModernUserDetails" }}
<div class="flex-1 space-y-4 p-4">
  <!-- Header Section -->
  <div class="flex items-center justify-between space-y-2">
    <h2 class="text-3xl font-bold tracking-tight">{{ .User.FirstName }}{{ if .User.LastName }} {{ .User.LastName }}{{ end }}</h2>
  </div>

  <div class="space-y-6">
    <!-- User ID Section -->
    <div class="flex items-center justify-between mb-4">
      <div>
        <p class="block text-sm font-medium mb-2">User ID</p>
        <div class="w-full inline-flex gap-x-2" id="clipboard-container-user_id">
          <input type="text" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm max-w-md" 
                 id="hs-clipboard-input-user_id" 
                 readonly="" 
                 value="{{ .User.UserID }}">
          <button class="justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 py-3 px-4 group inline-flex items-center gap-x-2 text-sm font-medium rounded-lg disabled:pointer-events-none" 
                  type="button" 
                  id="user_id">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy w-4 h-4 group-hover:rotate-6 transition">
              <rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect>
              <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path>
            </svg>
            <span>Copy</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-wrap gap-4 mb-4">
      <button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-10 rounded-md px-8 text-lg font-medium" 
              id="view-graph-button">
        <span class="mr-2">View Graph</span>
        <svg xmlns="http://www.w3.org/2000/svg" width="19" height="19" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-share2">
          <circle cx="18" cy="5" r="3"></circle>
          <circle cx="6" cy="12" r="3"></circle>
          <circle cx="18" cy="19" r="3"></circle>
          <line x1="8.59" x2="15.42" y1="13.51" y2="17.49"></line>
          <line x1="15.41" x2="8.59" y1="6.51" y2="10.49"></line>
        </svg>
      </button>
      <button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80 h-10 rounded-md px-8 text-lg font-medium"
              hx-get="{{ adminPath "/users/" }}{{ .User.UserID }}/episodes"
              hx-target="#page-content">
        <span class="mr-2">View Episodes</span>
        <svg xmlns="http://www.w3.org/2000/svg" width="19" height="19" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list-filter">
          <path d="M3 6h18"></path>
          <path d="M7 12h10"></path>
          <path d="M10 18h4"></path>
        </svg>
      </button>
    </div>

    <!-- User Details Form Card -->
    <div class="rounded-xl border bg-card text-card-foreground shadow p-6">
      <form id="user-update-form" 
            hx-patch="{{ .Path }}"
            hx-target="#page-content"
            hx-indicator="#save-button">
        <div class="space-y-4">
          <div>
            <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70" for="first_name">Full name</label>
            <div class="sm:flex space-y-2 sm:space-y-0 sm:space-x-2 mt-2">
              <input class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm" 
                     id="first_name" 
                     placeholder="First name" 
                     name="first_name" 
                     value="{{ .User.FirstName }}">
              <input class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm" 
                     id="last_name" 
                     placeholder="Last name" 
                     name="last_name" 
                     value="{{ .User.LastName }}">
            </div>
          </div>
          
          <div>
            <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70" for="email">Email</label>
            <input type="email" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm mt-2" 
                   id="email" 
                   placeholder="name@domain.com" 
                   name="email" 
                   value="{{ .User.Email }}">
          </div>
          
          <div>
            <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Created</label>
            <p class="mt-2 text-sm text-muted-foreground">{{if .User.CreatedAt}}{{ .User.CreatedAt.Format "Jan 2, 2006 3:04 PM" }}{{end}}</p>
          </div>
          
          <button id="save-button"
                  class="inline-flex items-center justify-start gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2" 
                  type="submit"
                  disabled>
            <span class="htmx-indicator hidden">
              <svg class="animate-spin h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </span>
            <span id="button-text">Save Changes</span>
          </button>
        </div>
      </form>
    </div>

    <!-- Sessions Section -->
    <div>
      <h3 class="text-lg font-medium mb-4">Sessions</h3>
      <div class="rounded-xl border bg-card text-card-foreground shadow">
        <div class="relative w-full overflow-auto">
          <table class="w-full caption-bottom text-sm">
            <thead class="[&_tr]:border-b">
              <tr class="border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted">
                <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0">Session</th>
                <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0">Created</th>
                <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0">Classifications</th>
              </tr>
            </thead>
            <tbody class="[&_tr:last-child]:border-0">
              {{if .Data.Rows}}
                {{range .Data.Rows}}
                <tr class="border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted" data-state="false">
                  <td class="p-4 align-middle [&:has([role=checkbox])]:pr-0">
                    <a class="text-primary hover:text-primary/80 hover:underline font-medium" 
                       href="{{ adminPath "/sessions/" }}{{ .Session.SessionID }}"
                       hx-get="{{ adminPath "/sessions/" }}{{ .Session.SessionID }}"
                       hx-target="#page-content"
                       hx-push-url="true">
                      {{ .Session.SessionID }}
                    </a>
                  </td>
                  <td class="p-4 align-middle [&:has([role=checkbox])]:pr-0">
                    <span class="text-muted-foreground">{{ .Session.CreatedAt.Format "Jan 2, 2006 3:04 PM" }}</span>
                  </td>
                  <td class="p-4 align-middle [&:has([role=checkbox])]:pr-0">
                    <span class="text-muted-foreground">-</span>
                  </td>
                </tr>
                {{end}}
              {{else}}
                <tr>
                  <td colspan="3" class="p-8 text-center text-muted-foreground">No sessions found</td>
                </tr>
              {{end}}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Danger Zone -->
    <div class="border-t pt-6 mt-8">
      <h3 class="text-base font-medium text-muted-foreground mb-4">Danger Zone</h3>
      <div class="bg-destructive/5 border border-destructive/20 rounded-md p-4">
        <div class="flex items-center justify-between">
          <div>
            <h4 class="font-medium">Delete this user</h4>
            <p class="text-sm text-muted-foreground mt-1">Once deleted, it will be permanently removed and cannot be recovered.</p>
          </div>
          <button id="delete-user-button"
                  class="inline-flex items-center justify-center gap-2 whitespace-nowrap font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90 h-8 rounded-md px-3 text-xs" 
                  type="button"
                  onclick="showDeleteModal()">
            <span class="htmx-indicator hidden">
              <svg class="animate-spin h-4 w-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </span>
            <span id="delete-button-text">Delete User</span>
          </button>
        </div>
      </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="delete-confirmation-modal" class="fixed inset-0 z-50 hidden">
      <!-- Backdrop -->
      <div class="fixed inset-0 bg-black/80 dark:bg-black/80 backdrop-blur-sm"></div>
      
      <!-- Modal -->
      <div class="fixed inset-0 flex items-center justify-center p-4">
        <div class="relative bg-white dark:bg-slate-900 rounded-xl shadow-2xl max-w-md w-full mx-4 border border-gray-300 dark:border-gray-600" style="background-color: white;" data-theme-bg="true">
          <!-- Modal Header -->
          <div class="flex items-center justify-between p-6 border-b border-gray-300 dark:border-gray-600">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Delete User</h3>
            <button type="button" onclick="hideDeleteModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <!-- Modal Body -->
          <div class="p-6">
            <div class="flex items-start space-x-4">
              <div class="flex-shrink-0">
                <svg class="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.864-.833-2.632 0L4.182 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
              </div>
              <div class="flex-1">
                <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Are you sure?</h4>
                <p class="text-sm text-gray-900 dark:text-white mb-4">
                  This will permanently delete the user <strong>{{ .User.FirstName }}{{ if .User.LastName }} {{ .User.LastName }}{{ end }}</strong> and all associated data. This action cannot be undone.
                </p>
                <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-md p-3">
                  <p class="text-xs text-red-600 dark:text-red-400">
                    <strong>Warning:</strong> All user sessions, messages, and graph data will be permanently removed.
                  </p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Modal Footer -->
          <div class="flex items-center justify-end gap-12 p-6 border-t border-gray-300 dark:border-gray-600">
            <button type="button" 
                    onclick="hideDeleteModal()"
                    class="inline-flex items-center justify-center gap-2 whitespace-nowrap font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring h-8 rounded-md px-3 text-xs border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground">
              Cancel
            </button>
            <button type="button" 
                    id="confirm-delete-button"
                    onclick="confirmDelete()"
                    class="inline-flex items-center justify-center gap-2 whitespace-nowrap font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90 h-8 rounded-md px-3 text-xs">
              <span class="htmx-indicator hidden">
                <svg class="animate-spin h-4 w-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </span>
              <span id="confirm-delete-text">Yes, Delete User</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('user-update-form');
  const saveButton = document.getElementById('save-button');
  const buttonText = document.getElementById('button-text');
  const loadingSpinner = saveButton.querySelector('.htmx-indicator');
  
  const firstNameInput = document.getElementById('first_name');
  const lastNameInput = document.getElementById('last_name');
  const emailInput = document.getElementById('email');
  
  // Store initial values
  const initialValues = {
    firstName: firstNameInput.value.trim(),
    lastName: lastNameInput.value.trim(),
    email: emailInput.value.trim()
  };
  
  // Check if button should be enabled
  function updateButtonState() {
    const currentValues = {
      firstName: firstNameInput.value.trim(),
      lastName: lastNameInput.value.trim(),
      email: emailInput.value.trim()
    };
    
    // Enable if there are changes OR if there's content but no saved data
    const hasChanges = currentValues.firstName !== initialValues.firstName ||
                      currentValues.lastName !== initialValues.lastName ||
                      currentValues.email !== initialValues.email;
    
    const hasCurrentContent = currentValues.firstName || currentValues.lastName || currentValues.email;
    const hasInitialData = initialValues.firstName || initialValues.lastName || initialValues.email;
    
    // Enable button if: there are changes OR (has content but no initial saved data)
    const shouldEnable = hasChanges || (hasCurrentContent && !hasInitialData);
    
    saveButton.disabled = !shouldEnable;
  }
  
  // Add event listeners to form inputs
  [firstNameInput, lastNameInput, emailInput].forEach(input => {
    input.addEventListener('input', updateButtonState);
  });
  
  // Initial button state check
  updateButtonState();
  
  // Handle form submission - show loading state
  form.addEventListener('submit', function() {
    loadingSpinner.classList.remove('hidden');
    buttonText.textContent = 'Saving...';
    saveButton.disabled = true;
  });
  
  // Handle HTMX events to reset button state
  form.addEventListener('htmx:afterRequest', function() {
    loadingSpinner.classList.add('hidden');
    buttonText.textContent = 'Save Changes';
    updateButtonState();
  });
});

// Delete Modal Functions
function showDeleteModal() {
  const modal = document.getElementById('delete-confirmation-modal');
  modal.classList.remove('hidden');
  
  // Ensure proper background colors based on theme
  const modalDialog = modal.querySelector('[data-theme-bg]');
  const isDark = document.documentElement.classList.contains('dark') || 
                 window.matchMedia('(prefers-color-scheme: dark)').matches;
  
  if (isDark) {
    modalDialog.style.backgroundColor = '#0f172a'; // slate-900
  } else {
    modalDialog.style.backgroundColor = '#ffffff'; // white
  }
  
  // Focus trap for accessibility
  const confirmButton = document.getElementById('confirm-delete-button');
  setTimeout(() => confirmButton.focus(), 100);
}

function hideDeleteModal() {
  const modal = document.getElementById('delete-confirmation-modal');
  modal.classList.add('hidden');
  
  // Reset modal state
  const confirmButton = document.getElementById('confirm-delete-button');
  const confirmText = document.getElementById('confirm-delete-text');
  const confirmSpinner = confirmButton.querySelector('.htmx-indicator');
  
  confirmButton.disabled = false;
  confirmText.textContent = 'Yes, Delete User';
  confirmSpinner.classList.add('hidden');
}

function confirmDelete() {
  const confirmButton = document.getElementById('confirm-delete-button');
  const confirmText = document.getElementById('confirm-delete-text');
  const confirmSpinner = confirmButton.querySelector('.htmx-indicator');
  const deleteButton = document.getElementById('delete-user-button');
  const deleteButtonText = document.getElementById('delete-button-text');
  const deleteButtonSpinner = deleteButton.querySelector('.htmx-indicator');
  
  // Show loading state in modal
  confirmButton.disabled = true;
  confirmText.textContent = 'Deleting...';
  confirmSpinner.classList.remove('hidden');
  
  // Show loading state in main button
  deleteButton.disabled = true;
  deleteButtonText.textContent = 'Deleting...';
  deleteButtonSpinner.classList.remove('hidden');
  
  // Create and configure HTMX request
  const deleteRequest = new XMLHttpRequest();
  deleteRequest.open('DELETE', '{{ .Path }}', true);
  deleteRequest.setRequestHeader('Content-Type', 'application/json');
  deleteRequest.setRequestHeader('HX-Request', 'true');
  deleteRequest.setRequestHeader('HX-Target', '#page-content');
  
  deleteRequest.onreadystatechange = function() {
    if (deleteRequest.readyState === XMLHttpRequest.DONE) {
      if (deleteRequest.status === 200) {
        // Success - hide modal and redirect to users list
        hideDeleteModal();
        
        // Show success message briefly then redirect
        const successMessage = document.createElement('div');
        successMessage.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
        successMessage.textContent = 'User deleted successfully';
        document.body.appendChild(successMessage);
        
        // Redirect to users list after short delay
        setTimeout(() => {
          window.location.href = '{{ adminPath "/users" }}';
        }, 1500);
        
      } else {
        // Error - reset states and show error
        hideDeleteModal();
        
        // Reset main button state
        deleteButton.disabled = false;
        deleteButtonText.textContent = 'Delete User';
        deleteButtonSpinner.classList.add('hidden');
        
        // Show error message
        const errorMessage = document.createElement('div');
        errorMessage.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
        errorMessage.textContent = 'Failed to delete user. Please try again.';
        document.body.appendChild(errorMessage);
        
        // Remove error message after 5 seconds
        setTimeout(() => {
          errorMessage.remove();
        }, 5000);
      }
    }
  };
  
  deleteRequest.onerror = function() {
    // Network error - reset states and show error
    hideDeleteModal();
    
    // Reset main button state
    deleteButton.disabled = false;
    deleteButtonText.textContent = 'Delete User';
    deleteButtonSpinner.classList.add('hidden');
    
    // Show error message
    const errorMessage = document.createElement('div');
    errorMessage.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
    errorMessage.textContent = 'Network error. Please check your connection and try again.';
    document.body.appendChild(errorMessage);
    
    // Remove error message after 5 seconds
    setTimeout(() => {
      errorMessage.remove();
    }, 5000);
  };
  
  // Send the delete request
  deleteRequest.send();
}

// Close modal when clicking outside of it
document.addEventListener('click', function(event) {
  const modal = document.getElementById('delete-confirmation-modal');
  const modalContent = modal.querySelector('.relative');
  
  if (event.target === modal && !modalContent.contains(event.target)) {
    hideDeleteModal();
  }
});

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    const modal = document.getElementById('delete-confirmation-modal');
    if (!modal.classList.contains('hidden')) {
      hideDeleteModal();
    }
  }
});
</script>
{{ end }}