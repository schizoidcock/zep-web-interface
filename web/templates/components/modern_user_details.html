{{ define "ModernUserDetails" }}
<div class="flex-1 space-y-4 p-4 mx-auto max-w-6xl px-6 sm:px-8 lg:px-12">
  <!-- Header Section -->
  <div class="flex items-center justify-between space-y-2">
    <h2 class="text-3xl font-bold tracking-tight">{{ .User.FirstName }}{{ if .User.LastName }} {{ .User.LastName }}{{ end }}</h2>
  </div>

  <div class="space-y-6">
    <!-- User ID Section -->
    <div class="flex items-center justify-between mb-4">
      <div>
        <p class="block text-sm font-medium mb-2">User ID</p>
        <div class="w-full inline-flex gap-x-2" id="clipboard-container-user_id">
          <input type="text" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm max-w-md" 
                 id="hs-clipboard-input-user_id" 
                 readonly="" 
                 value="{{ .User.UserID }}">
          <button class="justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 py-3 px-4 group inline-flex items-center gap-x-2 text-sm font-medium rounded-lg disabled:pointer-events-none" 
                  type="button" 
                  id="user_id">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy w-4 h-4 group-hover:rotate-6 transition">
              <rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect>
              <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path>
            </svg>
            <span>Copy</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-wrap gap-4 mb-4">
      <button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-10 rounded-md px-8 text-lg font-medium" 
              onclick="showGraphModal('{{ .User.UserID }}')"
              id="view-graph-button">
        <span class="mr-2">View Graph</span>
        <svg xmlns="http://www.w3.org/2000/svg" width="19" height="19" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-share2">
          <circle cx="18" cy="5" r="3"></circle>
          <circle cx="6" cy="12" r="3"></circle>
          <circle cx="18" cy="19" r="3"></circle>
          <line x1="8.59" x2="15.42" y1="13.51" y2="17.49"></line>
          <line x1="15.41" x2="8.59" y1="6.51" y2="10.49"></line>
        </svg>
      </button>
      <button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80 h-10 rounded-md px-8 text-lg font-medium"
              hx-get="{{ adminPath "/users/" }}{{ .User.UserID }}/episodes"
              hx-target="#page-content">
        <span class="mr-2">View Episodes</span>
        <svg xmlns="http://www.w3.org/2000/svg" width="19" height="19" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list-filter">
          <path d="M3 6h18"></path>
          <path d="M7 12h10"></path>
          <path d="M10 18h4"></path>
        </svg>
      </button>
    </div>

    <!-- User Details Form Card -->
    <div class="rounded-xl border bg-card text-card-foreground shadow p-6">
      <form id="user-update-form" 
            hx-patch="{{ .Path }}"
            hx-target="#page-content"
            hx-indicator="#save-button">
        <div class="space-y-4">
          <div>
            <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70" for="first_name">Full name</label>
            <div class="sm:flex space-y-2 sm:space-y-0 sm:space-x-2 mt-2">
              <input class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm" 
                     id="first_name" 
                     placeholder="First name" 
                     name="first_name" 
                     value="{{ .User.FirstName }}">
              <input class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm" 
                     id="last_name" 
                     placeholder="Last name" 
                     name="last_name" 
                     value="{{ .User.LastName }}">
            </div>
          </div>
          
          <div>
            <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70" for="email">Email</label>
            <input type="email" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm mt-2" 
                   id="email" 
                   placeholder="name@domain.com" 
                   name="email" 
                   value="{{ .User.Email }}">
          </div>
          
          <div>
            <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Created</label>
            <p class="mt-2 text-sm text-muted-foreground">{{if .User.CreatedAt}}{{ .User.CreatedAt.Format "Jan 2, 2006 3:04 PM" }}{{end}}</p>
          </div>
          
          <button id="save-button"
                  class="inline-flex items-center justify-start gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2" 
                  type="submit"
                  disabled>
            <span class="htmx-indicator hidden">
              <svg class="animate-spin h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </span>
            <span id="button-text">Save Changes</span>
          </button>
        </div>
      </form>
    </div>

    <!-- Sessions Section -->
    <div>
      <h3 class="text-lg font-medium mb-4">Sessions</h3>
      <div class="rounded-xl border bg-card text-card-foreground shadow">
        <div class="relative w-full overflow-auto">
          <table class="w-full caption-bottom text-sm">
            <thead class="[&_tr]:border-b">
              <tr class="border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted">
                <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0">Session</th>
                <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0">Created</th>
                <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0">Classifications</th>
              </tr>
            </thead>
            <tbody class="[&_tr:last-child]:border-0">
              {{if .Data.Rows}}
                {{range .Data.Rows}}
                <tr class="border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted" data-state="false">
                  <td class="p-4 align-middle [&:has([role=checkbox])]:pr-0">
                    <a class="text-primary hover:text-primary/80 hover:underline font-medium" 
                       href="{{ adminPath "/sessions/" }}{{ .Session.SessionID }}"
                       hx-get="{{ adminPath "/sessions/" }}{{ .Session.SessionID }}"
                       hx-target="#page-content"
                       hx-push-url="true">
                      {{ .Session.SessionID }}
                    </a>
                  </td>
                  <td class="p-4 align-middle [&:has([role=checkbox])]:pr-0">
                    <span class="text-muted-foreground">{{ .Session.CreatedAt.Format "Jan 2, 2006 3:04 PM" }}</span>
                  </td>
                  <td class="p-4 align-middle [&:has([role=checkbox])]:pr-0">
                    <span class="text-muted-foreground">-</span>
                  </td>
                </tr>
                {{end}}
              {{else}}
                <tr>
                  <td colspan="3" class="py-24 px-8 text-center text-muted-foreground text-lg">
                    <div class="flex flex-col items-center space-y-4 py-12 px-6">
                      <svg class="w-12 h-12 text-muted-foreground opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                      </svg>
                      <span>No sessions found</span>
                    </div>
                  </td>
                </tr>
              {{end}}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Danger Zone -->
    <div class="border-t pt-6 mt-8">
      <h3 class="text-base font-medium text-muted-foreground mb-4">Danger Zone</h3>
      <div class="bg-destructive/5 border border-destructive/20 rounded-md p-4">
        <div class="flex items-center justify-between">
          <div>
            <h4 class="font-medium">Delete this user</h4>
            <p class="text-sm text-muted-foreground mt-1">Once deleted, it will be permanently removed and cannot be recovered.</p>
          </div>
          <button id="delete-user-button"
                  class="inline-flex items-center justify-center gap-2 whitespace-nowrap font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90 h-8 rounded-md px-3 text-xs" 
                  type="button"
                  onclick="showDeleteModal()">
            <span id="delete-button-text">Delete User</span>
          </button>
        </div>
      </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="delete-confirmation-modal" class="fixed inset-0 z-50 hidden">
      <!-- Backdrop -->
      <div class="fixed inset-0 bg-black/80 dark:bg-black/80 backdrop-blur-sm"></div>
      
      <!-- Modal -->
      <div class="fixed inset-0 flex items-center justify-center p-4">
        <div class="relative rounded-xl shadow-2xl max-w-md w-full mx-4" id="modal-container" data-theme-bg="true">
          <!-- Modal Header -->
          <div class="flex items-center justify-between p-6" id="modal-header">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Delete User</h3>
            <button type="button" onclick="hideDeleteModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" style="padding: 0; margin: 0; width: auto; height: auto; background: none; border: none;">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <!-- Modal Body -->
          <div class="p-6">
            <div class="flex items-start space-x-4">
              <div class="flex-shrink-0">
                <svg class="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.864-.833-2.632 0L4.182 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
              </div>
              <div class="flex-1">
                <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Are you sure?</h4>
                <p class="text-sm text-gray-900 dark:text-white mb-4">
                  This will permanently delete the user <strong>{{ .User.FirstName }}{{ if .User.LastName }} {{ .User.LastName }}{{ end }}</strong> and all associated data. This action cannot be undone.
                </p>
                <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-md p-3">
                  <p class="text-xs text-red-600 dark:text-red-400">
                    <strong>Warning:</strong> All user sessions, messages, and graph data will be permanently removed.
                  </p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Modal Footer -->
          <div class="flex items-center justify-end p-6" id="modal-footer" style="gap: 10px;">
            <button type="button" 
                    onclick="hideDeleteModal()"
                    class="inline-flex items-center justify-center gap-2 whitespace-nowrap font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring h-10 rounded-md text-sm border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground" style="width: 100px; padding: 0 16px;">
              Cancel
            </button>
            <button type="button" 
                    id="confirm-delete-button"
                    onclick="confirmDelete()"
                    class="inline-flex items-center justify-center gap-2 whitespace-nowrap font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90 h-10 rounded-md text-sm" style="width: 150px; padding: 0 16px;">
              <span id="confirm-delete-text">Yes, Delete User</span>
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Hidden inputs for JavaScript -->
    <input type="hidden" id="graph-api-base-url" value="{{ adminPath "/users/" }}">
    
    <!-- Graph Modal -->
    <div id="graph-modal" class="fixed inset-0 z-50 hidden">
      <!-- Backdrop -->
      <div class="fixed inset-0 bg-black/80 dark:bg-black/80 backdrop-blur-sm"></div>
      
      <!-- Modal -->
      <div class="fixed inset-0 flex items-center justify-center p-4">
        <div class="relative rounded-xl shadow-2xl w-full max-w-5xl h-[85vh] mx-4" id="graph-modal-container" data-theme-bg="true">
          <!-- Modal Header -->
          <div class="flex items-center justify-between p-6" id="graph-modal-header" style="border-bottom: none;">
            <div>
              <h3 class="text-lg font-semibold">User Relationship Graph</h3>
              <p class="text-sm">Visualization of user relationships and connections</p>
            </div>
            <button type="button" onclick="hideGraphModal()" class="transition-colors" style="padding: 8px; margin: 0; background: none; border: none;">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <!-- Modal Body -->
          <div class="flex-1 overflow-hidden" style="height: calc(85vh - 140px);" id="graph-modal-body">
            <!-- Loading State -->
            <div id="graph-modal-loading" class="flex items-center justify-center h-full">
              <div class="flex flex-col items-center space-y-3">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                <div class="text-sm text-gray-400">Loading graph visualization...</div>
              </div>
            </div>
            
            <!-- Graph Content -->
            <div id="graph-modal-content" class="hidden h-full relative">
              <!-- Graph Canvas -->
              <div id="graph-modal-canvas" class="w-full h-full overflow-hidden relative"></div>
            </div>
            
            <!-- Empty State -->
            <div id="graph-modal-empty" class="hidden flex items-center justify-center h-full">
              <div class="flex flex-col items-center space-y-4">
                <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                </svg>
                <div class="space-y-2 text-center">
                  <h3 class="text-lg font-medium" id="empty-title">No Graph Data Available</h3>
                  <p class="max-w-md text-sm" id="empty-subtitle">
                    There are no relationships to visualize for this graph yet. Graph is updated asynchronously as new episodes are added.
                  </p>
                  <div class="flex items-center justify-center mt-6" id="empty-hint">
                    <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full border border-input bg-background shadow-sm text-sm">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                      <span>Try refreshing or check back later.</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Modal Footer -->
          <div class="absolute bottom-0 left-0 right-0 flex items-center justify-between p-6" id="graph-modal-footer" style="background: transparent; border: none;">
            <button onclick="refreshGraph()" class="inline-flex items-center justify-center gap-2 whitespace-nowrap font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 rounded-md px-4 text-sm" id="graph-refresh-btn">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              <span>Refresh</span>
            </button>
            <button onclick="hideGraphModal()" class="inline-flex items-center justify-center gap-2 whitespace-nowrap font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 rounded-md px-4 text-sm" id="graph-close-btn">
              <span>Close</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Add CSS animations for pulse effect (user modal)
if (!document.getElementById('user-modal-pulse-style')) {
  const userModalStyle = document.createElement('style');
  userModalStyle.id = 'user-modal-pulse-style';
  userModalStyle.textContent = `
    @keyframes pulse {
      0%, 100% {
        opacity: 0.3;
        transform: scale(0.92);
      }
      50% {
        opacity: 0.5;
        transform: scale(0.94);
      }
    }
  `;
  document.head.appendChild(userModalStyle);
}

// Initialize immediately when DOM is ready, before HTMX processes
document.addEventListener('DOMContentLoaded', function() {
  // Only initialize if we're on a page with the user update form
  if (document.getElementById('user-update-form')) {
    setTimeout(initializeSaveButton, 50);
  }
});

// Also initialize after HTMX loads
document.addEventListener('htmx:load', function() {
  // Only initialize if we're on a page with the user update form
  if (document.getElementById('user-update-form')) {
    initializeSaveButton();
  }
});

function initializeSaveButton() {
  const form = document.getElementById('user-update-form');
  const saveButton = document.getElementById('save-button');
  const buttonText = document.getElementById('button-text');
  const loadingSpinner = saveButton?.querySelector('.htmx-indicator');
  
  const firstNameInput = document.getElementById('first_name');
  const lastNameInput = document.getElementById('last_name');
  const emailInput = document.getElementById('email');
  
  // Verify all elements exist - if not, silently return (normal for other pages)
  if (!form || !saveButton || !buttonText || !firstNameInput || !lastNameInput || !emailInput) {
    // Only log in debug mode to avoid console errors on pages without user forms
    console.debug('User form elements not found - this is normal for non-user-details pages');
    return;
  }
  
  console.log('âœ… All DOM elements found, initializing Save Changes button logic');
  
  // Store initial values
  const initialValues = {
    firstName: firstNameInput.value.trim(),
    lastName: lastNameInput.value.trim(),
    email: emailInput.value.trim()
  };
  
  console.log('Initial values captured:', initialValues);
  
  // Initialize lastKnownValue for real-time monitoring
  firstNameInput.lastKnownValue = initialValues.firstName;
  lastNameInput.lastKnownValue = initialValues.lastName;
  emailInput.lastKnownValue = initialValues.email;
  
  // Check if button should be enabled - AGGRESSIVE override of any HTMX interference
  function updateButtonState() {
    const currentValues = {
      firstName: firstNameInput.value.trim(),
      lastName: lastNameInput.value.trim(),
      email: emailInput.value.trim()
    };
    
    // Check for changes - any field that's different from initial
    const firstNameChanged = currentValues.firstName !== initialValues.firstName;
    const lastNameChanged = currentValues.lastName !== initialValues.lastName;
    const emailChanged = currentValues.email !== initialValues.email;
    const hasChanges = firstNameChanged || lastNameChanged || emailChanged;
    
    // Specific deletion detection - check if we had data before but don't now
    const firstNameDeleted = initialValues.firstName && !currentValues.firstName;
    const lastNameDeleted = initialValues.lastName && !currentValues.lastName;
    const emailDeleted = initialValues.email && !currentValues.email;
    const hasDeletedData = firstNameDeleted || lastNameDeleted || emailDeleted;
    
    // Specific addition detection - check if we didn't have data before but do now
    const firstNameAdded = !initialValues.firstName && currentValues.firstName;
    const lastNameAdded = !initialValues.lastName && currentValues.lastName;
    const emailAdded = !initialValues.email && currentValues.email;
    const hasAddedData = firstNameAdded || lastNameAdded || emailAdded;
    
    const hasCurrentContent = currentValues.firstName || currentValues.lastName || currentValues.email;
    const hasInitialData = initialValues.firstName || initialValues.lastName || initialValues.email;
    
    // Enable button if: 
    // 1. There are ANY changes from initial state (including partial deletions), OR
    // 2. Data was deleted from any field, OR
    // 3. Data was added to any field, OR
    // 4. Has current content but no initial saved data (new user scenario)
    const shouldEnable = hasChanges || hasDeletedData || hasAddedData || (hasCurrentContent && !hasInitialData);
    
    // FORCEFULLY set button state - override any HTMX interference
    if (shouldEnable) {
      saveButton.removeAttribute('disabled');
      saveButton.disabled = false;
      console.log('ðŸŸ¢ ENABLING SAVE BUTTON - Detected changes');
    } else {
      saveButton.setAttribute('disabled', 'disabled');
      saveButton.disabled = true;
      console.log('ðŸ”´ DISABLING SAVE BUTTON - No changes detected');
    }
    
    // Enhanced debug logging to understand what's happening
    console.log('ðŸ” BUTTON STATE DEBUG:', {
      currentValues,
      initialValues,
      changes: {
        firstName: firstNameChanged,
        lastName: lastNameChanged,
        email: emailChanged
      },
      deletions: {
        firstName: firstNameDeleted,
        lastName: lastNameDeleted,
        email: emailDeleted
      },
      additions: {
        firstName: firstNameAdded,
        lastName: lastNameAdded,
        email: emailAdded
      },
      summary: {
        hasChanges,
        hasDeletedData,
        hasAddedData,
        hasCurrentContent,
        hasInitialData,
        shouldEnable,
        buttonActuallyDisabled: saveButton.disabled
      }
    });
    
    // Show specific message when deletion is detected
    if (hasDeletedData) {
      console.log('ðŸ—‘ï¸ DELETION DETECTED - Button should be enabled!');
    }
  }
  
  // Add event listeners to form inputs - multiple event types to catch all changes
  [firstNameInput, lastNameInput, emailInput].forEach(input => {
    // Listen to multiple events to ensure we catch all changes, especially deletions
    ['input', 'change', 'keyup', 'keydown', 'keypress', 'paste', 'cut', 'blur', 'focus'].forEach(eventType => {
      input.addEventListener(eventType, function(event) {
        // Special handling for deletion keys
        if (eventType === 'keydown' && (event.key === 'Backspace' || event.key === 'Delete')) {
          console.log(`ðŸ—‘ï¸ DELETION KEY DETECTED: ${event.key} on ${input.id}`);
          // Add a slight delay to ensure the value change is processed
          setTimeout(updateButtonState, 10);
          return;
        }
        
        console.log(`ðŸ“ Event triggered: ${eventType} on ${input.id}, value: "${input.value}"`);
        // Small delay to ensure paste/cut operations complete
        setTimeout(updateButtonState, 5);
      });
    });
    
    // Add specific deletion detection for better responsiveness
    input.addEventListener('keydown', function(event) {
      if (event.key === 'Backspace' || event.key === 'Delete') {
        // Store pre-deletion value to compare
        const preDeleteValue = input.value;
        console.log(`ðŸ” PRE-DELETE VALUE: "${preDeleteValue}" on ${input.id}`);
        
        // Check the value after the deletion happens
        setTimeout(() => {
          const postDeleteValue = input.value;
          console.log(`ðŸ” POST-DELETE VALUE: "${postDeleteValue}" on ${input.id}`);
          if (preDeleteValue !== postDeleteValue) {
            console.log(`âœ… DELETION CONFIRMED on ${input.id}: "${preDeleteValue}" â†’ "${postDeleteValue}"`);
            updateButtonState();
          }
        }, 1);
      }
    });
  });
  
  // Real-time monitoring - check every 100ms for changes
  setInterval(function() {
    const currentValues = {
      firstName: firstNameInput.value.trim(),
      lastName: lastNameInput.value.trim(),
      email: emailInput.value.trim()
    };
    
    // Only update if values actually changed to avoid spam
    const valuesChanged = currentValues.firstName !== firstNameInput.lastKnownValue ||
                         currentValues.lastName !== lastNameInput.lastKnownValue ||
                         currentValues.email !== emailInput.lastKnownValue;
    
    if (valuesChanged) {
      console.log('Real-time monitor detected change:', currentValues);
      firstNameInput.lastKnownValue = currentValues.firstName;
      lastNameInput.lastKnownValue = currentValues.lastName;
      emailInput.lastKnownValue = currentValues.email;
      updateButtonState();
    }
  }, 100);
  
  // Add MutationObserver to catch programmatic value changes
  const observer = new MutationObserver(function(mutations) {
    let shouldUpdate = false;
    mutations.forEach(function(mutation) {
      if (mutation.type === 'attributes' && mutation.attributeName === 'value') {
        console.log('MutationObserver detected value change on', mutation.target.id);
        shouldUpdate = true;
      }
    });
    if (shouldUpdate) {
      setTimeout(updateButtonState, 5);
    }
  });
  
  // Observe value attribute changes on all inputs
  [firstNameInput, lastNameInput, emailInput].forEach(input => {
    observer.observe(input, { attributes: true, attributeFilter: ['value'] });
  });
  
  // Initial button state check
  updateButtonState();
  
  // Add a global function for manual testing
  window.testButtonState = function() {
    console.log('=== MANUAL BUTTON STATE TEST ===');
    updateButtonState();
  };
  
  // Add a global function to reset initial values manually
  window.resetInitialValues = function() {
    initialValues.firstName = firstNameInput.value.trim();
    initialValues.lastName = lastNameInput.value.trim();
    initialValues.email = emailInput.value.trim();
    console.log('Reset initial values to:', initialValues);
    updateButtonState();
  };
  
  // Handle form submission - show loading state
  form.addEventListener('submit', function() {
    loadingSpinner.classList.remove('hidden');
    buttonText.textContent = 'Saving...';
    saveButton.disabled = true;
  });
  
  // Handle HTMX events to reset button state
  form.addEventListener('htmx:afterRequest', function(event) {
    loadingSpinner.classList.add('hidden');
    buttonText.textContent = 'Save Changes';
    
    // Update initial values after successful save
    if (event.detail.xhr.status >= 200 && event.detail.xhr.status < 300) {
      initialValues.firstName = firstNameInput.value.trim();
      initialValues.lastName = lastNameInput.value.trim();
      initialValues.email = emailInput.value.trim();
      
      console.log('âœ… Save successful! Updated initial values:', initialValues);
      
      // Show success notification BEFORE HTMX processes response
      // Store notification data to survive HTMX content replacement
      window.pendingNotification = {
        type: 'success',
        message: 'User changes saved successfully',
        timestamp: Date.now()
      };
      
      // Show notification immediately
      showSuccessNotificationPersistent('User changes saved successfully');
      
    } else {
      // Show error notification for failed save
      const errorMessage = event.detail.xhr.responseText || 'Failed to save changes. Please try again.';
      
      // Store error notification to survive HTMX content replacement
      window.pendingNotification = {
        type: 'error', 
        message: errorMessage,
        timestamp: Date.now()
      };
      
      showErrorNotificationPersistent(errorMessage);
    }
    
    updateButtonState();
  });
  
  // Handle HTMX errors
  form.addEventListener('htmx:responseError', function(event) {
    loadingSpinner.classList.add('hidden');
    buttonText.textContent = 'Save Changes';
    
    // Store error notification to survive HTMX content replacement
    window.pendingNotification = {
      type: 'error',
      message: 'Network error. Please check your connection and try again.',
      timestamp: Date.now()
    };
    
    // Show error notification for network/server errors
    showErrorNotificationPersistent('Network error. Please check your connection and try again.');
    
    updateButtonState();
  });
  
  // Close the initializeSaveButton function
}

// Additional HTMX override - prevent HTMX from disabling our button
document.addEventListener('htmx:beforeRequest', function(event) {
  const saveButton = document.getElementById('save-button');
  if (saveButton && event.target.id === 'user-update-form') {
    console.log('ðŸš« HTMX beforeRequest - preserving button logic');
    // Don't let HTMX automatically disable the button during submission
    // We'll handle it manually in our form submit handler
  }
});

document.addEventListener('htmx:afterRequest', function(event) {
  const saveButton = document.getElementById('save-button');
  if (saveButton && event.target.id === 'user-update-form') {
    console.log('ðŸ”„ HTMX afterRequest - reinitializing button logic');
    // Reinitialize button logic after HTMX request only if form exists
    setTimeout(initializeSaveButton, 10);
  }
});

// Delete Modal Functions - Make globally available
window.showDeleteModal = function() {
  const modal = document.getElementById('delete-confirmation-modal');
  
  // Add more prominent fade effect to the delete button when opening modal
  const deleteButton = document.getElementById('delete-user-button');
  if (deleteButton) {
    console.log('ðŸŽ¯ Applying delete button effects');
    deleteButton.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
    deleteButton.style.opacity = '0.4';
    deleteButton.style.transform = 'scale(0.92)';
    deleteButton.style.filter = 'blur(1px) brightness(0.8)';
    deleteButton.style.boxShadow = '0 0 20px rgba(239, 68, 68, 0.3)';
  } else {
    console.error('âŒ Delete button not found!');
  }
  
  // Show modal first
  modal.classList.remove('hidden');
  
  // Get modal container (not the backdrop)
  const modalContainer = modal.querySelector('#modal-container');
  
  // Add modal appear animation to container only
  modalContainer.style.opacity = '0';
  modalContainer.style.transform = 'scale(0.95)';
  modalContainer.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
  
  // Trigger appear animation
  setTimeout(() => {
    modalContainer.style.opacity = '1';
    modalContainer.style.transform = 'scale(1)';
  }, 10);
  
  // Get modal elements
  const modalHeader = modal.querySelector('#modal-header');
  const modalFooter = modal.querySelector('#modal-footer');
  
  // Enhanced theme detection - check multiple indicators
  const htmlElement = document.documentElement;
  const bodyElement = document.body;
  
  // Check for dark mode indicators
  const hasDarkClass = htmlElement.classList.contains('dark') || bodyElement.classList.contains('dark');
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  
  // Check actual computed styles of the page to detect current theme
  const bodyBgColor = window.getComputedStyle(bodyElement).backgroundColor;
  const htmlBgColor = window.getComputedStyle(htmlElement).backgroundColor;
  
  // Parse RGB values to determine if background is dark
  const isDarkBackground = (color) => {
    if (!color || color === 'transparent') return false;
    const rgb = color.match(/\d+/g);
    if (!rgb) return false;
    const [r, g, b] = rgb.map(Number);
    // Calculate relative luminance
    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
    return luminance < 0.3; // More strict threshold for dark detection
  };
  
  // Check if background is light (opposite of dark)
  const isLightBackground = (color) => {
    if (!color || color === 'transparent') return true; // Default to light
    const rgb = color.match(/\d+/g);
    if (!rgb) return true;
    const [r, g, b] = rgb.map(Number);
    // Calculate relative luminance  
    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
    return luminance > 0.7; // Light if luminance is greater than 70%
  };
  
  // Determine if we're in dark mode with multiple checks
  const bodyIsDark = isDarkBackground(bodyBgColor);
  const htmlIsDark = isDarkBackground(htmlBgColor);
  const bodyIsLight = isLightBackground(bodyBgColor);
  const htmlIsLight = isLightBackground(htmlBgColor);
  
  // Enhanced logic: prioritize actual background color detection
  let isDark;
  if (bodyIsLight || htmlIsLight) {
    isDark = false; // Force light mode if any element has light background
  } else if (bodyIsDark || htmlIsDark) {
    isDark = true; // Force dark mode if any element has dark background
  } else {
    isDark = hasDarkClass; // Fallback to class detection
  }
  
  // Enhanced theme detection logging
  console.log('Theme detection:', { 
    hasDarkClass, 
    prefersDark, 
    bodyBgColor, 
    htmlBgColor, 
    bodyIsDark,
    htmlIsDark,
    bodyIsLight,
    htmlIsLight,
    finalIsDark: isDark 
  });
  
  if (isDark) {
    // Dark mode styling
    modalContainer.style.setProperty('background-color', '#0f172a', 'important'); // slate-900
    modalContainer.style.setProperty('border', '1px solid #374151', 'important'); // gray-700
    modalContainer.style.setProperty('border-radius', '12px', 'important');
    modalContainer.style.setProperty('color', '#ffffff', 'important');
    modalHeader.style.setProperty('border-bottom', '1px solid #374151', 'important');
    modalHeader.style.setProperty('background-color', '#0f172a', 'important');
    modalHeader.style.setProperty('border-top-left-radius', '12px', 'important');
    modalHeader.style.setProperty('border-top-right-radius', '12px', 'important');
    modalFooter.style.setProperty('border-top', '1px solid #374151', 'important');
    modalFooter.style.setProperty('background-color', '#0f172a', 'important');
    modalFooter.style.setProperty('border-bottom-left-radius', '12px', 'important');
    modalFooter.style.setProperty('border-bottom-right-radius', '12px', 'important');
    
    // Force ALL text elements to white in dark mode
    const allTextElements = modal.querySelectorAll('*');
    allTextElements.forEach(element => {
      if (element.textContent && element.textContent.trim()) {
        element.style.setProperty('color', '#ffffff', 'important');
      }
    });
    
    // Style cancel button for dark mode
    const cancelButton = modal.querySelector('#modal-footer button[onclick="hideDeleteModal()"]');
    if (cancelButton) {
      cancelButton.style.setProperty('background-color', '#374151', 'important');
      cancelButton.style.setProperty('color', '#ffffff', 'important');
      cancelButton.style.setProperty('border', '1px solid #4b5563', 'important');
      cancelButton.style.setProperty('border-radius', '6px', 'important');
      cancelButton.style.setProperty('width', '100px', 'important');
      cancelButton.style.setProperty('padding', '0 16px', 'important');
      cancelButton.style.setProperty('height', '40px', 'important');
      
      cancelButton.removeEventListener('mouseenter', cancelButtonHoverDark);
      cancelButton.removeEventListener('mouseleave', cancelButtonLeaveDark);
      cancelButton.addEventListener('mouseenter', cancelButtonHoverDark);
      cancelButton.addEventListener('mouseleave', cancelButtonLeaveDark);
    }
    
    // Style delete button for dark mode consistency
    const deleteButton = modal.querySelector('#confirm-delete-button');
    if (deleteButton) {
      deleteButton.style.setProperty('width', '150px', 'important');
      deleteButton.style.setProperty('padding', '0 16px', 'important');
      deleteButton.style.setProperty('height', '40px', 'important');
    }
    
    // Style warning box for dark mode
    const warningBox = modal.querySelector('.bg-red-50');
    if (warningBox) {
      warningBox.style.setProperty('background-color', '#7f1d1d', 'important'); // red-900
      warningBox.style.setProperty('border', '1px solid #991b1b', 'important'); // red-800
    }
    
    const warningText = modal.querySelector('.text-red-600');
    if (warningText) {
      warningText.style.setProperty('color', '#fca5a5', 'important'); // red-300
    }
    
    const modalBody = modal.querySelector('.p-6:not(#modal-header):not(#modal-footer)');
    if (modalBody) {
      modalBody.style.setProperty('background-color', '#0f172a', 'important');
      modalBody.style.setProperty('border-radius', '0px', 'important');
    }
    
  } else {
    // Light mode styling
    modalContainer.style.setProperty('background-color', '#ffffff', 'important');
    modalContainer.style.setProperty('border', '1px solid #d1d5db', 'important');
    modalContainer.style.setProperty('border-radius', '12px', 'important');
    modalContainer.style.setProperty('color', '#000000', 'important');
    modalHeader.style.setProperty('border-bottom', '1px solid #d1d5db', 'important');
    modalHeader.style.setProperty('background-color', '#ffffff', 'important');
    modalHeader.style.setProperty('border-top-left-radius', '12px', 'important');
    modalHeader.style.setProperty('border-top-right-radius', '12px', 'important');
    modalFooter.style.setProperty('border-top', '1px solid #d1d5db', 'important');
    modalFooter.style.setProperty('background-color', '#ffffff', 'important');
    modalFooter.style.setProperty('border-bottom-left-radius', '12px', 'important');
    modalFooter.style.setProperty('border-bottom-right-radius', '12px', 'important');
    
    // Force ALL text elements to black in light mode
    const allTextElements = modal.querySelectorAll('*');
    allTextElements.forEach(element => {
      if (element.textContent && element.textContent.trim()) {
        element.style.setProperty('color', '#000000', 'important');
      }
    });
    
    // Style cancel button for light mode
    const cancelButton = modal.querySelector('#modal-footer button[onclick="hideDeleteModal()"]');
    if (cancelButton) {
      cancelButton.style.setProperty('background-color', '#ffffff', 'important');
      cancelButton.style.setProperty('color', '#000000', 'important');
      cancelButton.style.setProperty('border', '1px solid #d1d5db', 'important');
      cancelButton.style.setProperty('border-radius', '6px', 'important');
      cancelButton.style.setProperty('width', '100px', 'important');
      cancelButton.style.setProperty('padding', '0 16px', 'important');
      cancelButton.style.setProperty('height', '40px', 'important');
      
      cancelButton.removeEventListener('mouseenter', cancelButtonHover);
      cancelButton.removeEventListener('mouseleave', cancelButtonLeave);
      cancelButton.addEventListener('mouseenter', cancelButtonHover);
      cancelButton.addEventListener('mouseleave', cancelButtonLeave);
    }
    
    // Style delete button for light mode consistency
    const deleteButton = modal.querySelector('#confirm-delete-button');
    if (deleteButton) {
      deleteButton.style.setProperty('width', '150px', 'important');
      deleteButton.style.setProperty('padding', '0 16px', 'important');
      deleteButton.style.setProperty('height', '40px', 'important');
    }
    
    // Style warning box for light mode
    const warningBox = modal.querySelector('.bg-red-50');
    if (warningBox) {
      warningBox.style.setProperty('background-color', '#fef2f2', 'important');
      warningBox.style.setProperty('border', '1px solid #fecaca', 'important');
    }
    
    const warningText = modal.querySelector('.text-red-600');
    if (warningText) {
      warningText.style.setProperty('color', '#dc2626', 'important');
    }
    
    const modalBody = modal.querySelector('.p-6:not(#modal-header):not(#modal-footer)');
    if (modalBody) {
      modalBody.style.setProperty('background-color', '#ffffff', 'important');
      modalBody.style.setProperty('border-radius', '0px', 'important');
    }
  }
  
  // Ensure proper button spacing (10px gap)
  modalFooter.style.gap = '10px';
  
  // Focus trap for accessibility
  const confirmButton = document.getElementById('confirm-delete-button');
  setTimeout(() => confirmButton.focus(), 100);
}

// Helper functions for button hover states (light mode)
window.cancelButtonHover = function() {
  this.style.setProperty('color', '#000000', 'important');
  this.style.setProperty('background-color', '#f3f4f6', 'important');
}

window.cancelButtonLeave = function() {
  this.style.setProperty('color', '#000000', 'important');
  this.style.setProperty('background-color', '#ffffff', 'important');
}

// Helper functions for button hover states (dark mode)
window.cancelButtonHoverDark = function() {
  this.style.setProperty('color', '#ffffff', 'important');
  this.style.setProperty('background-color', '#4b5563', 'important');
}

window.cancelButtonLeaveDark = function() {
  this.style.setProperty('color', '#ffffff', 'important');
  this.style.setProperty('background-color', '#374151', 'important');
}

window.hideDeleteModal = function() {
  const modal = document.getElementById('delete-confirmation-modal');
  const modalContainer = modal.querySelector('#modal-container');
  
  // Add fade out effect to container only
  modalContainer.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
  modalContainer.style.opacity = '0';
  modalContainer.style.transform = 'scale(0.95)';
  
  // Reset delete button with smooth transition back to normal
  const deleteButton = document.getElementById('delete-user-button');
  if (deleteButton) {
    deleteButton.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
    deleteButton.style.opacity = '1';
    deleteButton.style.transform = 'scale(1)';
    deleteButton.style.filter = 'blur(0px) brightness(1)';
    deleteButton.style.boxShadow = 'none';
  }
  
  setTimeout(() => {
    modal.classList.add('hidden');
    modalContainer.style.opacity = '1'; // Reset for next time
    modalContainer.style.transform = 'scale(1)'; // Reset transform
  }, 400);
  
  // Reset modal state
  const confirmButton = document.getElementById('confirm-delete-button');
  const confirmText = document.getElementById('confirm-delete-text');
  
  confirmButton.disabled = false;
  confirmText.textContent = 'Yes, Delete User';
}

window.confirmDelete = function() {
  const confirmButton = document.getElementById('confirm-delete-button');
  const confirmText = document.getElementById('confirm-delete-text');
  const deleteButton = document.getElementById('delete-user-button');
  const deleteButtonText = document.getElementById('delete-button-text');
  
  // Immediately close modal with fade effect
  hideDeleteModal();
  
  // Add more prominent fade effect to main delete button with pulse animation
  deleteButton.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
  deleteButton.style.opacity = '0.3';
  deleteButton.style.transform = 'scale(0.92)';
  deleteButton.style.filter = 'blur(1px) grayscale(0.3)';
  deleteButton.disabled = true;
  
  // Add pulsing effect
  deleteButton.style.animation = 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite';
  
  // Show loading state in main button only (no spinner, just text)
  deleteButtonText.textContent = 'Deleting...';
  
  // Create and configure HTMX request
  const deleteRequest = new XMLHttpRequest();
  deleteRequest.open('DELETE', '{{ .Path }}', true);
  deleteRequest.setRequestHeader('Content-Type', 'application/json');
  deleteRequest.setRequestHeader('HX-Request', 'true');
  deleteRequest.setRequestHeader('HX-Target', '#page-content');
  
  deleteRequest.onreadystatechange = function() {
    if (deleteRequest.readyState === XMLHttpRequest.DONE) {
      if (deleteRequest.status === 200) {
        // Success - show bottom-right notification with ultra-persistent system
        showSuccessNotificationPersistent('User deleted successfully');
        
        // Reset button state with smooth transition back to normal
        deleteButton.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
        deleteButton.style.opacity = '1';
        deleteButton.style.transform = 'scale(1)';
        deleteButton.style.filter = 'blur(0px) grayscale(0)';
        deleteButton.style.animation = 'none';
        deleteButton.disabled = false;
        deleteButtonText.textContent = 'Delete User';
        
        // Redirect to users list after short delay
        setTimeout(() => {
          window.location.href = '{{ adminPath "/users" }}';
        }, 1500); // Increased delay to let notification show
        
      } else {
        // Error - reset states and show error
        deleteButton.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
        deleteButton.style.opacity = '1';
        deleteButton.style.transform = 'scale(1)';
        deleteButton.style.filter = 'blur(0px) grayscale(0)';
        deleteButton.style.animation = 'none';
        deleteButton.disabled = false;
        deleteButtonText.textContent = 'Delete User';
        
        // Show error notification with ultra-persistent system
        showErrorNotificationPersistent('Failed to delete user. Please try again.');
      }
    }
  };
  
  deleteRequest.onerror = function() {
    // Network error - reset states and show error
    deleteButton.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
    deleteButton.style.opacity = '1';
    deleteButton.style.transform = 'scale(1)';
    deleteButton.style.filter = 'blur(0px) grayscale(0)';
    deleteButton.style.animation = 'none';
    deleteButton.disabled = false;
    deleteButtonText.textContent = 'Delete User';
    
    // Show error notification with ultra-persistent system
    showErrorNotificationPersistent('Network error. Please check your connection and try again.');
  };
  
  // Send the delete request
  deleteRequest.send();
}

// Close modal when clicking outside of it
document.addEventListener('click', function(event) {
  const modal = document.getElementById('delete-confirmation-modal');
  const modalContent = modal.querySelector('.relative');
  
  if (event.target === modal && !modalContent.contains(event.target)) {
    hideDeleteModal();
  }
});

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    const modal = document.getElementById('delete-confirmation-modal');
    if (!modal.classList.contains('hidden')) {
      hideDeleteModal();
    }
  }
});

// Ultra-persistent notification system that survives ANY page changes
window.showSuccessNotificationPersistent = function(message) {
  console.log('ðŸ”” Creating ultra-persistent success notification for:', message);
  
  // Store notification in sessionStorage to survive ANY DOM changes
  const notificationData = {
    type: 'success',
    message: message,
    timestamp: Date.now(),
    duration: 7000
  };
  
  sessionStorage.setItem('zep_pending_notification', JSON.stringify(notificationData));
  console.log('ðŸ’¾ Stored notification in sessionStorage:', notificationData);
  
  // Show notification immediately
  createAndShowNotification(notificationData);
}

window.showErrorNotificationPersistent = function(message) {
  console.log('ðŸ”” Creating ultra-persistent error notification for:', message);
  
  // Store notification in sessionStorage to survive ANY DOM changes
  const notificationData = {
    type: 'error',
    message: message,
    timestamp: Date.now(),
    duration: 8000
  };
  
  sessionStorage.setItem('zep_pending_notification', JSON.stringify(notificationData));
  console.log('ðŸ’¾ Stored error notification in sessionStorage:', notificationData);
  
  // Show notification immediately
  createAndShowNotification(notificationData);
}

// Core notification creation function
window.createAndShowNotification = function(notificationData) {
  console.log('ðŸŽ¨ Creating visual notification:', notificationData);
  
  // Remove any existing notifications first
  const existingNotifications = document.querySelectorAll('[data-zep-notification]');
  existingNotifications.forEach(n => n.remove());
  
  const notification = document.createElement('div');
  notification.setAttribute('data-zep-notification', 'true');
  
  // Get theme detection
  const isDark = detectTheme();
  
  // Base styling with ultra-high z-index to ensure visibility and entrance effect
  notification.className = `fixed bottom-4 right-4 px-6 py-4 rounded-lg shadow-xl border-2 transform translate-x-full scale-75 opacity-0 transition-all duration-500 ease-out min-w-80 max-w-96 hover:scale-105`;
  notification.style.cssText = 'z-index: 999999; pointer-events: auto; position: fixed !important; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 20px rgba(59, 130, 246, 0.15);';
  
  // Determine colors based on notification type
  const isSuccess = notificationData.type === 'success';
  const borderColor = isSuccess ? 'border-green-500' : 'border-red-500';
  const iconColor = isSuccess ? 'bg-green-500' : 'bg-red-500';
  const iconPath = isSuccess 
    ? 'M5 13l4 4L19 7' 
    : 'M6 18L18 6M6 6l12 12';
  
  // Apply theme-specific styling
  if (isDark) {
    notification.classList.add('bg-gray-900', borderColor, 'text-white');
  } else {
    notification.classList.add('bg-white', borderColor, 'text-gray-900');
  }
  
  notification.innerHTML = `
    <div class="flex items-center space-x-3">
      <div class="flex-shrink-0">
        <div class="w-6 h-6 rounded-full ${iconColor} flex items-center justify-center animate-pulse">
          <svg class="w-4 h-4 text-white animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}"></path>
          </svg>
        </div>
      </div>
      <div class="flex-1 min-w-0">
        <div class="text-sm font-semibold">${isSuccess ? 'Success' : 'Error'} - ${notificationData.message}</div>
      </div>
      <button onclick="
        const notification = this.parentElement.parentElement;
        notification.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
        notification.style.transform = 'translateX(100%) scale(0.8) rotate(5deg)';
        notification.style.opacity = '0';
        notification.style.filter = 'blur(2px)';
        setTimeout(() => {
          notification.remove();
          sessionStorage.removeItem('zep_pending_notification');
        }, 600);
      " class="flex-shrink-0 ${isDark ? 'text-gray-400 hover:text-white' : 'text-gray-400 hover:text-gray-600'} transition-all duration-200 hover:scale-110 hover:rotate-90">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
  `;
  
  console.log(`ðŸ”” Ultra-persistent ${notificationData.type} notification created, will auto-remove in ${notificationData.duration}ms`);
  
  // Append directly to document.body with highest priority
  document.body.appendChild(notification);
  
  // Force style recalculation to ensure proper positioning
  notification.offsetHeight;
  
  // Dramatic entrance animation with bounce effect
  setTimeout(() => {
    notification.classList.remove('translate-x-full', 'scale-75', 'opacity-0');
    notification.classList.add('translate-x-0', 'scale-100', 'opacity-100');
    
    // Add a subtle bounce effect after slide-in
    setTimeout(() => {
      notification.style.transform = 'translateX(0) scale(1.05)';
      setTimeout(() => {
        notification.style.transform = 'translateX(0) scale(1)';
      }, 150);
    }, 300);
  }, 50);
  
  // Auto-remove after specified duration with dramatic exit animation
  const autoRemoveTimeout = setTimeout(() => {
    console.log(`ðŸ”” Ultra-persistent ${notificationData.type} notification auto-removing now`);
    
    // Dramatic exit animation: fade out, scale down, and slide away
    notification.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
    notification.style.transform = 'translateX(100%) scale(0.8) rotate(5deg)';
    notification.style.opacity = '0';
    notification.style.filter = 'blur(2px)';
    
    setTimeout(() => {
      if (notification.parentNode) {
        notification.remove();
        sessionStorage.removeItem('zep_pending_notification');
      }
    }, 600);
  }, notificationData.duration);
  
  // Store timeout ID for potential cancellation
  notification.autoRemoveTimeout = autoRemoveTimeout;
}

// Legacy notification functions (keep for delete functionality compatibility)
window.showSuccessNotification = function(message) {
  return showSuccessNotificationPersistent(message);
}

window.showErrorNotification = function(message) {
  return showErrorNotificationPersistent(message);
}

// HTMX and page load handler to restore notifications from sessionStorage
document.addEventListener('DOMContentLoaded', function() {
  checkAndRestoreNotification();
});

document.addEventListener('htmx:afterSettle', function(event) {
  checkAndRestoreNotification();
});

// Function to check sessionStorage and restore notifications
window.checkAndRestoreNotification = function() {
  const storedNotification = sessionStorage.getItem('zep_pending_notification');
  if (storedNotification) {
    try {
      const notificationData = JSON.parse(storedNotification);
      const elapsed = Date.now() - notificationData.timestamp;
      
      // Only restore if notification hasn't expired
      if (elapsed < notificationData.duration) {
        console.log('ðŸ”„ Restoring notification from sessionStorage:', notificationData);
        console.log(`â±ï¸ Time elapsed: ${elapsed}ms, Duration: ${notificationData.duration}ms`);
        
        // Update the duration to remaining time
        notificationData.duration = notificationData.duration - elapsed;
        
        createAndShowNotification(notificationData);
      } else {
        console.log('â° Stored notification has expired, removing from sessionStorage');
        sessionStorage.removeItem('zep_pending_notification');
      }
    } catch (e) {
      console.error('âŒ Error parsing stored notification:', e);
      sessionStorage.removeItem('zep_pending_notification');
    }
  }
}

// Theme detection function for notifications
window.detectTheme = function() {
  const htmlElement = document.documentElement;
  const bodyElement = document.body;
  
  // Check for dark mode indicators
  const hasDarkClass = htmlElement.classList.contains('dark') || bodyElement.classList.contains('dark');
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  
  // Check actual computed styles of the page to detect current theme
  const bodyBgColor = window.getComputedStyle(bodyElement).backgroundColor;
  const htmlBgColor = window.getComputedStyle(htmlElement).backgroundColor;
  
  // Parse RGB values to determine if background is dark
  const isDarkBackground = (color) => {
    if (!color || color === 'transparent') return false;
    const rgb = color.match(/\d+/g);
    if (!rgb) return false;
    const [r, g, b] = rgb.map(Number);
    // Calculate relative luminance
    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
    return luminance < 0.5; // Dark if luminance is less than 50%
  };
  
  // Determine if we're in dark mode with multiple checks
  const bodyIsDark = isDarkBackground(bodyBgColor);
  const htmlIsDark = isDarkBackground(htmlBgColor);
  
  // Enhanced logic: prioritize actual background color detection
  if (bodyIsDark || htmlIsDark) {
    return true; // Dark mode detected
  } else if (hasDarkClass) {
    return true; // Dark class detected
  } else {
    return false; // Default to light mode
  }
}

// Graph Modal Functions
window.showGraphModal = function(userId) {
  const modal = document.getElementById('graph-modal');
  const modalContainer = document.getElementById('graph-modal-container');
  const loading = document.getElementById('graph-modal-loading');
  const content = document.getElementById('graph-modal-content');
  const empty = document.getElementById('graph-modal-empty');
  
  // Store userId for refresh functionality
  window.currentGraphUserId = userId;
  
  // Show modal first
  modal.classList.remove('hidden');
  
  // Apply theme styling immediately
  applyGraphModalTheme();
  
  // Add modal appear animation with scaling (same as delete modal)
  modalContainer.style.opacity = '0';
  modalContainer.style.transform = 'scale(0.95)';
  modalContainer.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
  
  // Trigger appear animation
  setTimeout(() => {
    modalContainer.style.opacity = '1';
    modalContainer.style.transform = 'scale(1)';
  }, 10);
  
  // Show loading state
  loading.classList.remove('hidden');
  content.classList.add('hidden');
  empty.classList.add('hidden');
  
  // Load graph data
  loadGraphData(userId);
}

window.refreshGraph = function() {
  if (window.currentGraphUserId) {
    const loading = document.getElementById('graph-modal-loading');
    const content = document.getElementById('graph-modal-content');
    const empty = document.getElementById('graph-modal-empty');
    
    // Show loading state
    loading.classList.remove('hidden');
    content.classList.add('hidden');
    empty.classList.add('hidden');
    
    // Clear existing graph
    const canvas = document.getElementById('graph-modal-canvas');
    if (canvas) canvas.innerHTML = '';
    
    // Reload graph data
    loadGraphData(window.currentGraphUserId);
  }
}

window.hideGraphModal = function() {
  const modal = document.getElementById('graph-modal');
  const modalContainer = document.getElementById('graph-modal-container');
  
  // Add fade out effect to container with scaling (same as delete modal)
  modalContainer.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
  modalContainer.style.opacity = '0';
  modalContainer.style.transform = 'scale(0.95)';
  
  setTimeout(() => {
    modal.classList.add('hidden');
    // Clear graph content
    const canvas = document.getElementById('graph-modal-canvas');
    if (canvas) canvas.innerHTML = '';
    // Clear stored user ID
    window.currentGraphUserId = null;
    // Reset transform for next time
    modalContainer.style.opacity = '1';
    modalContainer.style.transform = 'scale(1)';
  }, 400);
}

window.loadGraphData = function(userId) {
  const loading = document.getElementById('graph-modal-loading');
  const content = document.getElementById('graph-modal-content');
  const empty = document.getElementById('graph-modal-empty');
  
  // Make API request to get graph data
  const graphUrl = document.getElementById('graph-api-base-url').value + userId + '/graph';
  fetch(graphUrl, {
    method: 'GET',
    headers: {
      'Accept': 'application/json',
      'HX-Request': 'true'
    }
  })
  .then(response => response.text())
  .then(html => {
    // Parse the HTML response to extract graph data
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const graphDataScript = doc.getElementById('graph-data');
    
    if (graphDataScript) {
      try {
        const triplets = JSON.parse(graphDataScript.textContent);
        
        if (triplets && triplets.length > 0) {
          // Show graph content
          loading.classList.add('hidden');
          content.classList.remove('hidden');
          
          // Re-apply theme styling after content is shown
          applyGraphModalTheme();
          
          // Initialize graph visualization
          initializeModalGraph(triplets);
        } else {
          // Show empty state
          loading.classList.add('hidden');
          empty.classList.remove('hidden');
          
          // Re-apply theme styling for empty state
          applyGraphModalTheme();
        }
      } catch (e) {
        console.error('Failed to parse graph data:', e);
        loading.classList.add('hidden');
        empty.classList.remove('hidden');
        applyGraphModalTheme();
      }
    } else {
      // No graph data found, show empty state
      loading.classList.add('hidden');
      empty.classList.remove('hidden');
      applyGraphModalTheme();
    }
  })
  .catch(error => {
    console.error('Failed to load graph data:', error);
    loading.classList.add('hidden');
    empty.classList.remove('hidden');
    applyGraphModalTheme();
  });
}

window.initializeModalGraph = function(triplets) {
  // Convert triplets to nodes and edges for D3.js
  const nodes = new Map();
  const edges = [];
  
  triplets.forEach(triplet => {
    // Add source node
    if (!nodes.has(triplet.sourceNode.uuid)) {
      nodes.set(triplet.sourceNode.uuid, {
        id: triplet.sourceNode.uuid,
        name: triplet.sourceNode.name || 'Unnamed',
        labels: triplet.sourceNode.labels || [],
        summary: triplet.sourceNode.summary || '',
        type: 'node'
      });
    }
    
    // Add target node
    if (!nodes.has(triplet.targetNode.uuid)) {
      nodes.set(triplet.targetNode.uuid, {
        id: triplet.targetNode.uuid,
        name: triplet.targetNode.name || 'Unnamed',
        labels: triplet.targetNode.labels || [],
        summary: triplet.targetNode.summary || '',
        type: 'node'
      });
    }
    
    // Add episode as edge
    edges.push({
      id: triplet.episode.uuid,
      source: triplet.sourceNode.uuid,
      target: triplet.targetNode.uuid,
      name: triplet.episode.name || 'Related to',
      fact: triplet.episode.fact || '',
      content: triplet.episode.content || '',
      type: 'episode'
    });
  });
  
  const nodeArray = Array.from(nodes.values());
  
  // Update node count
  document.getElementById('modal-node-count').textContent = nodeArray.length;
  
  // Initialize D3 visualization in modal
  const container = document.getElementById('graph-modal-canvas');
  const width = container.offsetWidth;
  const height = container.offsetHeight;
  
  // Clear any existing content
  container.innerHTML = '';
  
  // Create SVG
  const svg = d3.select(container)
    .append('svg')
    .attr('width', width)
    .attr('height', height);
  
  // Apply theme styling to SVG
  const isDark = detectTheme();
  if (isDark) {
    svg.style('background-color', '#0f172a')
       .style('background-image', 'radial-gradient(circle, #374151 1px, transparent 1px)')
       .style('background-size', '20px 20px');
  } else {
    svg.style('background-color', '#ffffff')
       .style('background-image', 'radial-gradient(circle, #d1d5db 1px, transparent 1px)')
       .style('background-size', '20px 20px');
  }
  
  // Create zoom behavior
  const zoom = d3.zoom()
    .scaleExtent([0.1, 4])
    .on('zoom', (event) => {
      g.attr('transform', event.transform);
    });
  
  svg.call(zoom);
  
  const g = svg.append('g');
  
  // Create force simulation
  const simulation = d3.forceSimulation(nodeArray)
    .force('link', d3.forceLink(edges).id(d => d.id).distance(100))
    .force('charge', d3.forceManyBody().strength(-300))
    .force('center', d3.forceCenter(width / 2, height / 2))
    .force('collision', d3.forceCollide().radius(30));
  
  // Create links
  const link = g.append('g')
    .attr('class', 'links')
    .selectAll('line')
    .data(edges)
    .enter()
    .append('line')
    .attr('stroke', '#999')
    .attr('stroke-opacity', 0.6)
    .attr('stroke-width', 2);
  
  // Create nodes
  const node = g.append('g')
    .attr('class', 'nodes')
    .selectAll('circle')
    .data(nodeArray)
    .enter()
    .append('circle')
    .attr('r', 12)
    .attr('fill', d => getNodeColor(d.labels))
    .attr('stroke', '#fff')
    .attr('stroke-width', 2)
    .style('cursor', 'pointer')
    .call(d3.drag()
      .on('start', dragstarted)
      .on('drag', dragged)
      .on('end', dragended));
  
  // Add labels
  const labels = g.append('g')
    .attr('class', 'labels')
    .selectAll('text')
    .data(nodeArray)
    .enter()
    .append('text')
    .text(d => d.name)
    .attr('font-size', '10px')
    .attr('dy', -15)
    .attr('text-anchor', 'middle')
    .attr('fill', 'currentColor')
    .style('pointer-events', 'none');
  
  // Add tooltips
  node.append('title')
    .text(d => `${d.name}\nLabels: ${d.labels.join(', ')}\nSummary: ${d.summary}`);
  
  link.append('title')
    .text(d => `${d.name}\nFact: ${d.fact}\nContent: ${d.content}`);
  
  // Update positions on tick
  simulation.on('tick', () => {
    link
      .attr('x1', d => d.source.x)
      .attr('y1', d => d.source.y)
      .attr('x2', d => d.target.x)
      .attr('y2', d => d.target.y);
    
    node
      .attr('cx', d => d.x)
      .attr('cy', d => d.y);
    
    labels
      .attr('x', d => d.x)
      .attr('y', d => d.y);
  });
  
  // Control handlers
  document.getElementById('modal-reset-view').onclick = () => {
    svg.transition().duration(750).call(
      zoom.transform,
      d3.zoomIdentity.translate(width / 2, height / 2).scale(1)
    );
  };
  
  let labelsVisible = true;
  document.getElementById('modal-toggle-labels').onclick = () => {
    labelsVisible = !labelsVisible;
    labels.style('opacity', labelsVisible ? 1 : 0);
  };
  
  // Drag functions
  function dragstarted(event, d) {
    if (!event.active) simulation.alphaTarget(0.3).restart();
    d.fx = d.x;
    d.fy = d.y;
  }
  
  function dragged(event, d) {
    d.fx = event.x;
    d.fy = event.y;
  }
  
  function dragended(event, d) {
    if (!event.active) simulation.alphaTarget(0);
    d.fx = null;
    d.fy = null;
  }
  
  // Color function for nodes based on labels
  function getNodeColor(labels) {
    if (!labels || labels.length === 0) return '#6b7280';
    
    const colorMap = {
      'Person': '#ef4444',
      'Organization': '#3b82f6', 
      'Location': '#10b981',
      'Event': '#f59e0b',
      'Concept': '#8b5cf6',
      'Entity': '#6b7280'
    };
    
    return colorMap[labels[0]] || '#6b7280';
  }
}

window.applyGraphModalTheme = function() {
  const modalContainer = document.getElementById('graph-modal-container');
  const modalHeader = document.getElementById('graph-modal-header');
  const modalFooter = document.getElementById('graph-modal-footer');
  const modalBody = document.getElementById('graph-modal-body');
  const canvas = document.getElementById('graph-modal-canvas');
  
  // Detect theme
  const isDark = detectTheme();
  
  if (isDark) {
    // Dark mode styling - Very dark background like in screenshot
    modalContainer.style.setProperty('background-color', '#1a1a1a', 'important');
    modalContainer.style.setProperty('border', '1px solid #374151', 'important');
    modalContainer.style.setProperty('border-radius', '12px', 'important');
    modalContainer.style.setProperty('color', '#ffffff', 'important');
    modalHeader.style.setProperty('background-color', '#1a1a1a', 'important');
    modalHeader.style.setProperty('border-top-left-radius', '12px', 'important');
    modalHeader.style.setProperty('border-top-right-radius', '12px', 'important');
    modalBody.style.setProperty('background-color', '#1a1a1a', 'important');
    modalFooter.style.setProperty('background-color', 'transparent', 'important');
    
    // Update canvas background for dark theme
    if (canvas) {
      canvas.style.setProperty('background-color', '#0f172a', 'important'); // Darker background for graph
      canvas.style.setProperty('border-radius', '8px', 'important');
      // Add subtle grid pattern like in screenshot
      canvas.style.setProperty('background-image', 'radial-gradient(circle, #374151 1px, transparent 1px)', 'important');
      canvas.style.setProperty('background-size', '20px 20px', 'important');
    }
    
    // Update header text colors for dark theme
    const title = modalHeader.querySelector('h3');
    const subtitle = modalHeader.querySelector('p');
    const closeBtn = modalHeader.querySelector('button');
    if (title) title.style.setProperty('color', '#ffffff', 'important');
    if (subtitle) subtitle.style.setProperty('color', '#9ca3af', 'important');
    if (closeBtn) {
      closeBtn.style.setProperty('color', '#9ca3af', 'important');
      // Remove existing listeners before adding new ones
      closeBtn.onmouseenter = () => closeBtn.style.setProperty('color', '#ffffff', 'important');
      closeBtn.onmouseleave = () => closeBtn.style.setProperty('color', '#9ca3af', 'important');
    }
    
    // Update empty state colors for dark theme
    const emptyTitle = document.getElementById('empty-title');
    const emptySubtitle = document.getElementById('empty-subtitle');
    const emptyHint = document.getElementById('empty-hint');
    const emptyIcon = document.querySelector('#graph-modal-empty svg');
    if (emptyTitle) emptyTitle.style.setProperty('color', '#ffffff', 'important');
    if (emptySubtitle) emptySubtitle.style.setProperty('color', '#9ca3af', 'important');
    if (emptyHint) emptyHint.style.setProperty('color', '#6b7280', 'important');
    if (emptyIcon) emptyIcon.style.setProperty('color', '#6b7280', 'important');
    
    // Update footer button colors for dark theme
    const refreshBtn = document.getElementById('graph-refresh-btn');
    const footerCloseBtn = document.getElementById('graph-close-btn');
    if (refreshBtn) {
      refreshBtn.style.setProperty('background-color', '#374151', 'important');
      refreshBtn.style.setProperty('border-color', '#4b5563', 'important');
      refreshBtn.style.setProperty('color', '#ffffff', 'important');
    }
    if (footerCloseBtn) {
      footerCloseBtn.style.setProperty('background-color', '#374151', 'important');
      footerCloseBtn.style.setProperty('border-color', '#4b5563', 'important');
      footerCloseBtn.style.setProperty('color', '#ffffff', 'important');
    }
    
    // Update empty hint container for dark theme
    const emptyHintContainer = document.querySelector('#empty-hint .inline-flex');
    const emptyHintIcon = document.querySelector('#empty-hint .inline-flex svg');
    if (emptyHintContainer) {
      emptyHintContainer.style.setProperty('background-color', '#374151', 'important');
      emptyHintContainer.style.setProperty('border-color', '#4b5563', 'important');
      emptyHintContainer.style.setProperty('color', '#ffffff', 'important');
    }
    if (emptyHintIcon) {
      emptyHintIcon.style.setProperty('color', '#ffffff', 'important');
    }
    
  } else {
    // Light mode styling - Light background like in screenshot  
    modalContainer.style.setProperty('background-color', '#f8f9fa', 'important');
    modalContainer.style.setProperty('border', '1px solid #d1d5db', 'important');
    modalContainer.style.setProperty('border-radius', '12px', 'important');
    modalContainer.style.setProperty('color', '#000000', 'important');
    modalHeader.style.setProperty('background-color', '#f8f9fa', 'important');
    modalHeader.style.setProperty('border-top-left-radius', '12px', 'important');
    modalHeader.style.setProperty('border-top-right-radius', '12px', 'important');
    modalBody.style.setProperty('background-color', '#f8f9fa', 'important');
    modalFooter.style.setProperty('background-color', 'transparent', 'important');
    
    // Update canvas background for light theme
    if (canvas) {
      canvas.style.setProperty('background-color', '#ffffff', 'important'); // White background for graph
      canvas.style.setProperty('border-radius', '8px', 'important');
      // Add subtle grid pattern like in screenshot
      canvas.style.setProperty('background-image', 'radial-gradient(circle, #d1d5db 1px, transparent 1px)', 'important');
      canvas.style.setProperty('background-size', '20px 20px', 'important');
    }
    
    // Update header text colors for light theme
    const title = modalHeader.querySelector('h3');
    const subtitle = modalHeader.querySelector('p');
    const closeBtn = modalHeader.querySelector('button');
    if (title) title.style.setProperty('color', '#000000', 'important');
    if (subtitle) subtitle.style.setProperty('color', '#6b7280', 'important');
    if (closeBtn) {
      closeBtn.style.setProperty('color', '#6b7280', 'important');
      closeBtn.onmouseenter = () => closeBtn.style.setProperty('color', '#000000', 'important');
      closeBtn.onmouseleave = () => closeBtn.style.setProperty('color', '#6b7280', 'important');
    }
    
    // Update empty state colors for light theme
    const emptyTitle = document.getElementById('empty-title');
    const emptySubtitle = document.getElementById('empty-subtitle');
    const emptyHint = document.getElementById('empty-hint');
    const emptyIcon = document.querySelector('#graph-modal-empty svg');
    if (emptyTitle) emptyTitle.style.setProperty('color', '#000000', 'important');
    if (emptySubtitle) emptySubtitle.style.setProperty('color', '#6b7280', 'important');
    if (emptyHint) emptyHint.style.setProperty('color', '#9ca3af', 'important');
    if (emptyIcon) emptyIcon.style.setProperty('color', '#9ca3af', 'important');
    
    // Update footer button colors for light theme
    const refreshBtn = document.getElementById('graph-refresh-btn');
    const footerCloseBtn = document.getElementById('graph-close-btn');
    if (refreshBtn) {
      refreshBtn.style.setProperty('background-color', '#ffffff', 'important');
      refreshBtn.style.setProperty('border-color', '#d1d5db', 'important');
      refreshBtn.style.setProperty('color', '#000000', 'important');
    }
    if (footerCloseBtn) {
      footerCloseBtn.style.setProperty('background-color', '#ffffff', 'important');
      footerCloseBtn.style.setProperty('border-color', '#d1d5db', 'important');
      footerCloseBtn.style.setProperty('color', '#000000', 'important');
    }
    
    // Update empty hint container for light theme
    const emptyHintContainer = document.querySelector('#empty-hint .inline-flex');
    const emptyHintIcon = document.querySelector('#empty-hint .inline-flex svg');
    if (emptyHintContainer) {
      emptyHintContainer.style.setProperty('background-color', '#ffffff', 'important');
      emptyHintContainer.style.setProperty('border-color', '#d1d5db', 'important');
      emptyHintContainer.style.setProperty('color', '#000000', 'important');
    }
    if (emptyHintIcon) {
      emptyHintIcon.style.setProperty('color', '#000000', 'important');
    }
  }
}

// Close graph modal when clicking outside
document.addEventListener('click', function(event) {
  const modal = document.getElementById('graph-modal');
  const modalContent = modal?.querySelector('.relative');
  
  if (modal && event.target === modal && modalContent && !modalContent.contains(event.target)) {
    hideGraphModal();
  }
});

// Close graph modal with Escape key
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    const modal = document.getElementById('graph-modal');
    if (modal && !modal.classList.contains('hidden')) {
      hideGraphModal();
    }
  }
});

// Listen for theme changes and update graph modal if it's open
window.addEventListener('on-hs-appearance-change', function(event) {
  const modal = document.getElementById('graph-modal');
  if (modal && !modal.classList.contains('hidden')) {
    // Re-apply theme styling when theme changes
    applyGraphModalTheme();
  }
});
</script>

<!-- Load D3.js for graph visualization -->
<script src="https://d3js.org/d3.v7.min.js"></script>
{{ end }}